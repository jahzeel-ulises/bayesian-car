import pygame
from Car import Car
from Map import Map
import threading
import time
import random 
import math

map =[
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
]

P_Behave = {0: 0.6208053691275168, 1: 0.37919463087248323}
P_Dir_Behave = {1: {0: 0.15471698113207547, 1: 0.30943396226415093, 2: 0.15471698113207547, 3: 0.38113207547169814}, 0: {0: 0.18385843763487267, 1: 0.3344842468709538, 2: 0.20457488131204143, 3: 0.2770824341821321}}
P_S1_Dir = {0: {'mu': 6.060975609756097, 'std': 6.299809052516053}, 1: {'mu': 3.8536585365853657, 'std': 4.930490962796824}, 2: {'mu': 7.2560975609756095, 'std': 6.4037237924599335}, 3: {'mu': 2.9257425742574257, 'std': 3.808791962290571}}
P_S2_Dir = {0: {'mu': 10.585365853658537, 'std': 4.7660093292215695}, 1: {'mu': 12.646341463414634, 'std': 3.7412374555270262}, 2: {'mu': 11.341463414634147, 'std': 4.280935377755839}, 3: {'mu': 12.98019801980198, 'std': 3.7028433286883713}}
P_S3_Dir = {0: {'mu': 7.195121951219512, 'std': 4.316031053991429}, 1: {'mu': 7.25, 'std': 4.164375648266772}, 2: {'mu': 5.7073170731707314, 'std': 4.298974338997527}, 3: {'mu': 4.207920792079208, 'std': 1.9410046723213985}}
P_Angle_Dir = {0: {'mu': 4.515072086768028, 'std': 1.5499897308376678}, 1: {'mu': 0.5051036049741364, 'std': 0.8631389391315667}, 2: {'mu': 1.4826029191997652, 'std': 0.6007464233058709}, 3: {'mu': 3.0768420263881517, 'std': 0.7837855763006014}}

def norm_dist(x,mu,sigma):
  return (1/math.sqrt(2*math.pi*sigma))*math.exp(-0.5*(((x-mu)/sigma)**2))

def prob_Dir_S1S2S3Angle(Dir,S1,S2,S3,Angle):
  sum = 0
  for i in range(2):
    sum += math.log(P_Behave[i]) + math.log(P_Dir_Behave[i][Dir]) + math.log(norm_dist(S1,P_S1_Dir[Dir]["mu"],P_S1_Dir[Dir]["std"])) + math.log(norm_dist(S2,P_S2_Dir[Dir]["mu"],P_S2_Dir[Dir]["std"])) + math.log(norm_dist(S3,P_S3_Dir[Dir]["mu"],P_S3_Dir[Dir]["std"])) + math.log(norm_dist(Angle,P_Angle_Dir[Dir]["mu"],P_Angle_Dir[Dir]["std"])) 
  return sum

class thread_():
    def __init__(self,map,img) -> None:
        self.run_ = True
        self.map_ = map
        self.img_ = img

    def run(self,car):
        """Updates car position each 0.5 seconds.

        Parameters
        -----------
        car: Object car
        """
        self.run_ = True
        while self.run_:
            distances = car.get_distances(self.map_)
            angle = car.get_angle(self.map_)
            prob = [prob_Dir_S1S2S3Angle(i,distances[0],distances[1],distances[2],angle) for i in range(4)]
            pred = prob.index(max(prob))
            print(angle)
            car.dir_ = int(pred)
            self.img_ = rotate_img(pygame.transform.scale(pygame.image.load("car.png"),(30,30)),car.dir_)
            car.update_position()
            time.sleep(0.2)
    
    def stop(self):
        """Stops the while in self.run method."""
        self.run_ = False

def isin(car,maps):
    """Checks if the car is in the target zone
    
    Parameters
    ------------
    car: Object car

    maps: Object map

    Returns
    -------------
    bool:
        True if car is in the zone, False if not
    """
    return (car.position_[0] >= maps.zone_[0] and car.position_[0] <= maps.zone_[0] + 2) and (car.position_[1] >= maps.zone_[1] and car.position_[1] <= maps.zone_[1]+2)

def drawWalls(map,screen):
    """Draws the map and the zone in a pygame screen"""
    i,j = len(map.map_[0]), len(map.map_)

    pygame.draw.rect(screen, (255,0,0), pygame.Rect(map.zone_[1]*20, map.zone_[0]*20, 60, 60))
    for x in range(i):
        for y in range(j):
            if map.map_[y][x] == 1:
                pygame.draw.rect(screen, (0,0,0), pygame.Rect(x*20, y*20, 20, 20))

def drawCar(screen,img,car):
     """Draws the car in the screen"""
     screen.blit(img,(car.position_[1]*20,car.position_[0]*20))


def rotate_img(img,dir):
    if dir == 0:
        return pygame.transform.rotate(img,180)
    if dir == 1:
        return pygame.transform.rotate(img,90)
    if dir == 3:
        return pygame.transform.rotate(img,-90)
    if dir == 2:
        return img

pygame.init()
surface = pygame.display.set_mode((1130,670))

maps = Map(map)
maps.create_zone()
car = Car(maps.random_pos(),2)

img = pygame.image.load("car.png")
img = pygame.transform.scale(img,(30,30))

t = thread_(maps,img)
hilo = threading.Thread(target=t.run,args=(car,))
hilo.start()

while True:
        for event in pygame.event.get():
            if event.type==pygame.QUIT:
                pygame.quit()
                t.stop()
                break
            
            if event.type == pygame.KEYDOWN: 
                if event.key == pygame.K_LEFT:
                    car.update_dir(-1)
                    img = pygame.transform.rotate(img,90)
                if event.key == pygame.K_RIGHT:
                    car.update_dir(1)
                    img = pygame.transform.rotate(img,-90)
        
        surface.fill((255,255,255))
        drawWalls(maps,surface)
        drawCar(surface,t.img_,car)
        if isin(car,maps):
            t.stop()

            maps = Map(map)
            maps.create_zone()
            t.map_ = maps

            dir = random.randint(0,3)

            img = pygame.image.load("car.png")
            img = pygame.transform.scale(img,(30,30))
            img = rotate_img(img,dir)
            print(maps.random_pos())
            car = Car(maps.random_pos(),dir)
            
            t = thread_(maps,img)
            hilo = threading.Thread(target=t.run,args=(car,))
            hilo.start()
        pygame.display.flip()